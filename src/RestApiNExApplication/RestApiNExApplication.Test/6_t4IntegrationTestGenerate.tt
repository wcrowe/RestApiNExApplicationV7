
<#@ include file="../RestApiNExApplication.Entity/TemplateCommon.tt"#>

<#
	var tc = new TemplateCommon();

	//get list of entity clases to use as templated to create domain clases
	List<EnvDTE.CodeClass> entityClassesNotExistsinTest = tc.GetClassesToCreate(false,"RestApiNExApplication.Entity", "BaseEntity","RestApiNExApplication.Test", "BaseTest","Test");
#>
// —————————————— 
// <auto-generated> 
//	This code was auto-generated <#= DateTime.Now #>
//	T4 template generates test code 
//	NOTE:T4 generated code may need additional updates/addjustments by developer in order to compile a solution.
// <auto-generated> 
// —————————————–
using System;
using System.Collections.Generic;
using System.IO;
using System.Net;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using RestApiNExApplication.Api;
using RestApiNExApplication.Domain;
using IdentityModel.Client;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.TestHost;
using Microsoft.Extensions.Configuration;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using Xunit;
using static JWT.Controllers.TokenController;

namespace RestApiNExApplication.Test
{
	#region unit tests
<#
	foreach(EnvDTE.CodeClass cl in entityClassesNotExistsinTest)
	{
	var entityName = cl.Name;
	var entityNamelc = cl.Name.ToLower();
                  var entityRequiredPropsInitiated = tc.GetEntityRequiredPropsInitiated(cl);
#>
	#region <#= entityName #> tests

    /// <summary>
    ///
    /// <#= entityName #> API Integration tests
    ///
    /// MANUAL UPDATES REQUIRED!
    ///
    /// NOTE: In order to run an pass these scaffolded tests they have to be manually adjusted 
    ///       according to new entity class properties - search for MANUAL UPDATES REQUIRED!
    ///
    /// </summary>
    [Collection("HttpClient collection")]
    public class <#= entityName #>Test: BaseTest
    {
        public HttpClientFixture fixture;
        public <#= entityName #>Test(HttpClientFixture fixture)
        {
            this.fixture = fixture;
            var client = fixture.Client;
        }

        public static string LastAdded<#= entityName #> { get; set; }

        #region <#= entityName #> tests

        [Fact]
        public async Task <#= entityNamelc #>_getall()
        {
            var httpclient = fixture.Client;
            if (String.IsNullOrEmpty(TokenTest.TokenValue)) await TokenTest.token_get(httpclient);
            //
            var util = new UtilityExt();
                        //MANUAL UPDATES REQUIRED!
			//todo - add if any parent of the entity
			//add entity
            var <#= entityNamelc #>id = await util.add<#= entityName #>(httpclient);
            //
            httpclient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", TokenTest.TokenValue);
            var response = await httpclient.GetAsync("/api/<#= entityNamelc #>");
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.OK, response.StatusCode);
            var jsonString = await response.Content.ReadAsStringAsync();
            var vmenititys = (ICollection<UserViewModel>)JsonConvert.DeserializeObject<IEnumerable<UserViewModel>>(jsonString);
            Assert.True(vmenititys.Count > 0);
            // lazy-loading test if entity has children
            response = await httpclient.GetAsync("/api/<#= entityNamelc #>/" + <#= entityNamelc #>id.ToString());
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.OK, response.StatusCode);
            jsonString = await response.Content.ReadAsStringAsync();
            var vmenitity = JsonConvert.DeserializeObject<<#= entityName #>ViewModel>(jsonString);
            //Assert.True(vmenitity.Kids.Count == 1);
            //clean
            await util.remove<#= entityName #>(httpclient, <#= entityNamelc #>id);
			//remove if any parent entity added 
        }


        [Fact]
        public async Task <#= entityNamelc #>_add_update_delete()
        {
            var httpclient = fixture.Client;;
            if (String.IsNullOrEmpty(TokenTest.TokenValue)) await TokenTest.token_get(httpclient);
            //
            <#= entityName #>ViewModel <#= entityNamelc #> = new <#= entityName #>ViewModel
            {
			//MANUAL UPDATES REQUIRED!
			TestText = "tt"
            			<#= entityRequiredPropsInitiated #>
            };

            httpclient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", TokenTest.TokenValue);
            var response = await httpclient.PostAsync("/api/<#= entityNamelc #>", new StringContent(
                                                               JsonConvert.SerializeObject(<#= entityNamelc #>), Encoding.UTF8, "application/json"));
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.Created, response.StatusCode);
            var lastAddedId = await response.Content.ReadAsStringAsync();
            Assert.True(int.Parse(lastAddedId) > 1);
            int id = 0; int.TryParse(lastAddedId, out id);

            //get inserted
            var util = new UtilityExt();
            var vmentity = await util.Get<#= entityName #>(httpclient, id);

            //update test
            vmentity.TestText = "tt updated";
            response = await httpclient.PutAsync("/api/<#= entityNamelc #>/" + id.ToString(), new StringContent(JsonConvert.SerializeObject(vmentity), Encoding.UTF8, "application/json"));
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.Accepted, response.StatusCode);

            //confirm update
            Thread.Sleep(5000); //wait to get expired lazycache - see appsettings
            response = await httpclient.GetAsync("/api/<#= entityNamelc #>/" + id.ToString());
            response.EnsureSuccessStatusCode();
            var jsonString = await response.Content.ReadAsStringAsync();
            var oj = JObject.Parse(jsonString);
            var tt = oj["testText"].ToString();
            Assert.Equal(tt, vmentity.TestText);

            //another update with same <#= entityName #> - concurrency
            vmentity.TestText = "tt updated 2";
            response = await httpclient.PutAsync("/api/<#= entityNamelc #>/" + id.ToString(), new StringContent(JsonConvert.SerializeObject(vmentity), Encoding.UTF8, "application/json"));
            Assert.Equal(HttpStatusCode.PreconditionFailed, response.StatusCode);

            //delete test 
            response = await httpclient.DeleteAsync("/api/<#= entityNamelc #>/" + id.ToString());
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.NoContent, response.StatusCode);
        }

        [Fact]
        public async Task <#= entityNamelc #>_getbyid()
        {
			var httpclient = fixture.Client;
            if (String.IsNullOrEmpty(TokenTest.TokenValue)) await TokenTest.token_get(httpclient);
            //
            var util = new UtilityExt();
	                //MANUAL UPDATES REQUIRED!
			//todo - add parent of the entity if exist
			//add entity
            var <#= entityNamelc #>id = await util.add<#= entityName #>(httpclient);
            //
            httpclient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", TokenTest.TokenValue);
            var response = await httpclient.GetAsync("/api/<#= entityNamelc #>/" + <#= entityNamelc #>id.ToString());
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.OK, response.StatusCode);
            var jsonString = await response.Content.ReadAsStringAsync();
            var vmenitity = JsonConvert.DeserializeObject<<#= entityName #>ViewModel>(jsonString);
            Assert.True(vmenitity.TestText == "tt updated");
			
            //clean
            await util.remove<#= entityName #>(httpclient, <#= entityNamelc #>id);
	    //remove if any parent entity added 
        }

        [Fact]
        public async Task <#= entityNamelc #>_cache()
        {
            var httpclient = fixture.Client;;
            if (String.IsNullOrEmpty(TokenTest.TokenValue)) await TokenTest.token_get(httpclient);
            //
            <#= entityName #>ViewModel <#= entityNamelc #> = new <#= entityName #>ViewModel
            {
			//MANUAL UPDATES REQUIRED!
			TestText = "tt"
            			<#= entityRequiredPropsInitiated #>
            };

            httpclient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", TokenTest.TokenValue);
            var response = await httpclient.PostAsync("/api/<#= entityNamelc #>", new StringContent(
                                                               JsonConvert.SerializeObject(<#= entityNamelc #>), Encoding.UTF8, "application/json"));
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.Created, response.StatusCode);
            var lastAddedId = await response.Content.ReadAsStringAsync();
            Assert.True(int.Parse(lastAddedId) > 1);
            int id = 0; int.TryParse(lastAddedId, out id);

            //get inserted
            var util = new UtilityExt();
            var vmentity = await util.Get<#= entityName #>(httpclient, id);

            //update test
            var cachedValue = vmentity.TestText;
            vmentity.TestText = "tt updated";
            response = await httpclient.PutAsync("/api/<#= entityNamelc #>/" + id.ToString(), new StringContent(JsonConvert.SerializeObject(vmentity), Encoding.UTF8, "application/json"));
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.Accepted, response.StatusCode);

            //confirm update
            response = await httpclient.GetAsync("/api/<#= entityNamelc #>/" + id.ToString());
            response.EnsureSuccessStatusCode();
            var jsonString = await response.Content.ReadAsStringAsync();
            var oj = JObject.Parse(jsonString);
            var tt = oj["testText"].ToString();
            Assert.Equal(tt, cachedValue);

            //another update with same <#= entityName #> - concurrency
            vmentity.TestText = "tt updated 2";
            response = await httpclient.PutAsync("/api/<#= entityNamelc #>/" + id.ToString(), new StringContent(JsonConvert.SerializeObject(vmentity), Encoding.UTF8, "application/json"));
            Assert.Equal(HttpStatusCode.PreconditionFailed, response.StatusCode);

            //delete test 
            response = await httpclient.DeleteAsync("/api/<#= entityNamelc #>/" + id.ToString());
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.NoContent, response.StatusCode);
        }

        #endregion

        #region <#= entityName #> async tests

        [Fact]
        public async Task <#= entityNamelc #>_getallasync()
        {
            var httpclient = fixture.Client;
            if (String.IsNullOrEmpty(TokenTest.TokenValue)) await TokenTest.token_get(httpclient);
            //
            var util = new UtilityExt();
			//MANUAL UPDATES REQUIRED!
			//todo - add parent of the entity if exist
			//add entity
            var <#= entityNamelc #>id = await util.add<#= entityName #>(httpclient);
            //
            httpclient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", TokenTest.TokenValue);
            var response = await httpclient.GetAsync("/api/<#= entityNamelc #>async");
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.OK, response.StatusCode);
            var jsonString = await response.Content.ReadAsStringAsync();
            var vmenititys = (ICollection<UserViewModel>)JsonConvert.DeserializeObject<IEnumerable<UserViewModel>>(jsonString);
            Assert.True(vmenititys.Count > 0);
            // lazy-loading test if entity has children
            response = await httpclient.GetAsync("/api/<#= entityNamelc #>async/" + <#= entityNamelc #>id.ToString());
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.OK, response.StatusCode);
            jsonString = await response.Content.ReadAsStringAsync();
            var vmenitity = JsonConvert.DeserializeObject<<#= entityName #>ViewModel>(jsonString);
            //Assert.True(vmenitity.Kids.Count == 1);
            //clean
            await util.remove<#= entityName #>(httpclient, <#= entityNamelc #>id);
			//remove if any parent entity added 
        }


        [Fact]
        public async Task <#= entityNamelc #>_add_update_delete_async()
        {
            var httpclient = fixture.Client;;
            if (String.IsNullOrEmpty(TokenTest.TokenValue)) await TokenTest.token_get(httpclient);
            //
            <#= entityName #>ViewModel <#= entityNamelc #> = new <#= entityName #>ViewModel
            {
			//MANUAL UPDATES REQUIRED!
			//initiate viewmodel object
			TestText = "tt"
            			<#= entityRequiredPropsInitiated #>
            };

            httpclient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", TokenTest.TokenValue);
            var response = await httpclient.PostAsync("/api/<#= entityNamelc #>async", new StringContent(
                                                               JsonConvert.SerializeObject(<#= entityNamelc #>), Encoding.UTF8, "application/json"));
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.Created, response.StatusCode);
            var lastAddedId = await response.Content.ReadAsStringAsync();
            Assert.True(int.Parse(lastAddedId) > 1);
            int id = 0; int.TryParse(lastAddedId, out id);

            //get inserted
            var util = new UtilityExt();
            var vmentity = await util.Get<#= entityName #>Async(httpclient, id);

            //update test
            vmentity.TestText = "tt updated";
            response = await httpclient.PutAsync("/api/<#= entityNamelc #>async/" + id.ToString(), new StringContent(JsonConvert.SerializeObject(vmentity), Encoding.UTF8, "application/json"));
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.Accepted, response.StatusCode);

            //confirm update
            Thread.Sleep(5000); //wait to get expired lazycache - see appsettings
            response = await httpclient.GetAsync("/api/<#= entityNamelc #>async/" + id.ToString());
            response.EnsureSuccessStatusCode();
            var jsonString = await response.Content.ReadAsStringAsync();
            var oj = JObject.Parse(jsonString);
            var tt = oj["testText"].ToString();
            Assert.Equal(tt, vmentity.TestText);

            //another update with same <#= entityName #> - concurrency
            vmentity.TestText = "tt updated 2";
            response = await httpclient.PutAsync("/api/<#= entityNamelc #>async/" + id.ToString(), new StringContent(JsonConvert.SerializeObject(vmentity), Encoding.UTF8, "application/json"));
            Assert.Equal(HttpStatusCode.PreconditionFailed, response.StatusCode);

            //delete test 
            response = await httpclient.DeleteAsync("/api/<#= entityNamelc #>async/" + id.ToString());
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.NoContent, response.StatusCode);

        }

        [Fact]
        public async Task <#= entityNamelc #>_getbyidasync()
        {

			var httpclient = fixture.Client;
            if (String.IsNullOrEmpty(TokenTest.TokenValue)) await TokenTest.token_get(httpclient);
            //
            var util = new UtilityExt();
			//MANUAL UPDATES REQUIRED!
			//todo - add if any parent of the entity
			//add entity
            var <#= entityNamelc #>id = await util.add<#= entityName #>(httpclient);
            //
            httpclient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", TokenTest.TokenValue);
            var response = await httpclient.GetAsync("/api/<#= entityNamelc #>async/" + <#= entityNamelc #>id.ToString());
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.OK, response.StatusCode);
            var jsonString = await response.Content.ReadAsStringAsync();
            var vmenitity = JsonConvert.DeserializeObject<<#= entityName #>ViewModel>(jsonString);
            Assert.True(vmenitity.TestText == "tt updated");
			
            //clean
            await util.remove<#= entityName #>(httpclient, <#= entityNamelc #>id);
	    //remove if any parent entity added 
        }

        [Fact]
        public async Task <#= entityNamelc #>_cache_async()
        {
            var httpclient = fixture.Client;;
            if (String.IsNullOrEmpty(TokenTest.TokenValue)) await TokenTest.token_get(httpclient);
            //
            <#= entityName #>ViewModel <#= entityNamelc #> = new <#= entityName #>ViewModel
            {
			//MANUAL UPDATES REQUIRED!
			//initiate viewmodel object
			TestText = "tt"
            			<#= entityRequiredPropsInitiated #>
            };

            httpclient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", TokenTest.TokenValue);
            var response = await httpclient.PostAsync("/api/<#= entityNamelc #>async", new StringContent(
                                                               JsonConvert.SerializeObject(<#= entityNamelc #>), Encoding.UTF8, "application/json"));
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.Created, response.StatusCode);
            var lastAddedId = await response.Content.ReadAsStringAsync();
            Assert.True(int.Parse(lastAddedId) > 1);
            int id = 0; int.TryParse(lastAddedId, out id);

            //get inserted
            var util = new UtilityExt();
            var vmentity = await util.Get<#= entityName #>Async(httpclient, id);

            //update test
            var cachedValue = vmentity.TestText;
            vmentity.TestText = "tt updated";
            response = await httpclient.PutAsync("/api/<#= entityNamelc #>async/" + id.ToString(), new StringContent(JsonConvert.SerializeObject(vmentity), Encoding.UTF8, "application/json"));
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.Accepted, response.StatusCode);

            //confirm update
            response = await httpclient.GetAsync("/api/<#= entityNamelc #>async/" + id.ToString());
            response.EnsureSuccessStatusCode();
            var jsonString = await response.Content.ReadAsStringAsync();
            var oj = JObject.Parse(jsonString);
            var tt = oj["testText"].ToString();
            Assert.Equal(tt, cachedValue);

            //another update with same <#= entityName #> - concurrency
            vmentity.TestText = "tt updated 2";
            response = await httpclient.PutAsync("/api/<#= entityNamelc #>async/" + id.ToString(), new StringContent(JsonConvert.SerializeObject(vmentity), Encoding.UTF8, "application/json"));
            Assert.Equal(HttpStatusCode.PreconditionFailed, response.StatusCode);

            //delete test 
            response = await httpclient.DeleteAsync("/api/<#= entityNamelc #>async/" + id.ToString());
            response.EnsureSuccessStatusCode();
            Assert.Equal(HttpStatusCode.NoContent, response.StatusCode);

        }

        #endregion
	}
        #endregion
<#
   }
#>

    #endregion

    #region Shared test

    public class UtilityExt
    {
<#
	foreach(EnvDTE.CodeClass cl in entityClassesNotExistsinTest)
	{
	var entityName = cl.Name;
	var entityNamelc = cl.Name.ToLower();
                  var entityRequiredPropsInitiated = tc.GetEntityRequiredPropsInitiated(cl);
#>

        public async Task<int> add<#= entityName #>(HttpClient client)
        {
		    
            <#= entityName #>ViewModel vmentity = new <#= entityName #>ViewModel
            {
			//MANUAL UPDATES REQUIRED!
			//initiate viewmodel object
			TestText = "tt updated"
            			<#= entityRequiredPropsInitiated #>
            };

            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", TokenTest.TokenValue);
            var response = await client.PostAsync("/api/<#= entityNamelc #>", new StringContent(
                                                               JsonConvert.SerializeObject(vmentity), Encoding.UTF8, "application/json"));
            var jsonString = await response.Content.ReadAsStringAsync();
            int lastAdded = 0;
            int.TryParse(jsonString, out lastAdded);
            return lastAdded;
        }

        public async Task<<#= entityName #>ViewModel> Get<#= entityName #>Async(HttpClient client, int id)
        {
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", TokenTest.TokenValue);
            var response = await client.GetAsync("/api/<#= entityNamelc #>async/" + id.ToString());
            response.EnsureSuccessStatusCode();
            var jsonString = await response.Content.ReadAsStringAsync();
            var vmentity = JsonConvert.DeserializeObject<<#= entityName #>ViewModel>(jsonString);
            return vmentity;
        }

        public async Task<<#= entityName #>ViewModel> Get<#= entityName #>(HttpClient client, int id)
        {
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", TokenTest.TokenValue);
            var response = await client.GetAsync("/api/<#= entityNamelc #>/" + id.ToString());
            response.EnsureSuccessStatusCode();
            var jsonString = await response.Content.ReadAsStringAsync();
            var vmentity = JsonConvert.DeserializeObject<<#= entityName #>ViewModel>(jsonString);
            return vmentity;
        }

        public async Task remove<#= entityName #>(HttpClient client, int id)
        {
            await client.DeleteAsync("/api/<#= entityNamelc #>/" + id.ToString());
        }

<#
   }
#>
	}
	 #endregion
}

